# 游戏功能更新记录

## 更新日期：2026-01-25

---

## 1. 闯关模式功能

### 1.1 体力消耗
- **开始关卡**：每次进入闯关模式关卡消耗 **5点体力**
- **下一关**：过关后点击"下一关"不再额外消耗体力（体力只在首次进入游戏时扣除）
- **体力上限**：200点

### 1.2 星级评定规则
根据通关时间评定星级：
| 时间 | 星级 |
|------|------|
| ≤ 2分钟（120秒） | ⭐⭐⭐ 三星 |
| ≤ 3分钟（180秒） | ⭐⭐ 二星 |
| > 3分钟 | ⭐ 一星 |

### 1.3 计时器
- 闯关模式使用**正计时**（从0开始）
- 每关开始时计时器重置为0
- 计时持续运行直到通关

---

## 2. 通关奖励系统

### 2.1 奖励生成规则
- **三个品类随机选两个**（每次通关获得2种奖励）
- 奖励计算在**后端进行**，防止前端数据篡改

### 2.2 奖励品类和概率

| 品类 | 80% 概率 | 19% 概率 | 1% 概率 |
|------|----------|----------|---------|
| ⚡ 体力 | 5点 | 10点 | 20点 |
| 💡 提示 | 1点 | 2点 | 5点 |
| 🔊 发音 | 1点 | 2点 | 3点 |

### 2.3 领取流程
1. 通关后奖励**自动显示**（从后端获取）
2. 用户点击"领奖"按钮领取
3. 领取后**后端更新**用户的体力、道具数据
4. 前端显示更新后的数据

### 2.4 后端API
- `POST /api/game/generate-reward` - 生成随机奖励（预览）
- `POST /api/game/claim-reward` - 领取奖励并更新用户数据

---

## 3. 体力恢复系统

### 3.1 登录恢复规则
- **恢复速率**：每小时恢复 10点体力
- **最小间隔**：两次登录间隔不足1小时，不奖励体力
- **最大恢复**：超过10小时的，最多只奖励100点体力（10小时 × 10点/小时）

### 3.2 计算公式
```
恢复体力 = min(离线小时数 × 10, 100)
条件：离线时间 >= 1小时
```

---

## 4. 关卡加载优化

### 4.1 问题
原实现一次性加载整个词库关卡数据（如GRE词库12MB），导致加载延迟严重。

### 4.2 解决方案
- 改为**按需加载单关数据**，响应时间 8-9ms
- 后台**预加载下一关**，提升游戏体验
- 后端API关卡范围扩展到2000关，支持大词库

---

## 5. 数据同步机制

### 5.1 同步项目
| 数据类型 | 同步时机 | 后端API |
|----------|----------|---------|
| 体力 | 消耗/恢复时 | `PUT /api/user/energy` |
| 道具 | 使用/获得时 | `PUT /api/user/props` |
| 积分 | 每关结束 | `POST /api/game/score` |
| 奖励 | 领取时 | `POST /api/game/claim-reward` |

### 5.2 安全考虑
- 奖励计算在后端进行，防止前端篡改
- 所有数据更新通过后端API完成
- 前端只负责显示，不做核心计算

---

## 6. 游戏界面

### 6.1 胜利弹窗
- 统计数据一行显示：`⏱️时间 · 🌟积分 · 📝单词数`
- 星级显示与通关时间匹配
- 三个按钮：返回、领奖、下一关

### 6.2 单词选择
- 进入关卡后**自动选中第一个未完成单词**
- 答对后**自动切换到下一个未完成单词**
- 单词按 `clue_number` 排序，同编号横向优先

---

## 7. 各模式体力消耗

| 游戏模式 | 体力消耗 |
|----------|----------|
| 闯关模式 | 5点/关 |
| 计时模式 | 10点/局 |
| PK模式 | 10点/局 |
| 无限模式 | 10点/局 |

---

## 8. 计时/PK/无限模式功能（2026-01-26 更新）

### 8.1 三种模式的计时逻辑

| 模式 | 计时方式 | 时间设置 | 过关处理 |
|------|----------|----------|----------|
| 计时模式 | 总时间倒计时 | 固定3分钟 | 自动续下一关，无弹窗 |
| PK模式 | 总时间倒计时 | 固定3分钟 | 自动续下一关，无弹窗 |
| 无限模式 | 每关倒计时 | 每关3分钟 | 自动续关，重置计时器 |

### 8.2 游戏流程

**计时/PK模式**：
1. 开始游戏，消耗10点体力
2. 总计时器开始倒计时（3分钟）
3. 完成一关 → 自动加载下一关（不停止计时，不显示弹窗）
4. 积分累加（每词10分）
5. 时间到 → 显示结果弹窗（总关卡数、总单词数、总积分）
6. 可选：领奖、再玩一次（扣10点体力）、返回主页

**无限模式**：
1. 开始游戏，消耗10点体力
2. 每关计时器开始倒计时（3分钟）
3. 完成一关 → 自动加载下一关，重置计时器
4. 积分累加
5. 单关时间用尽 → 显示结果弹窗
6. 可选：领奖、再玩一次、返回主页

### 8.3 累计统计

- `sessionScore` - 本局累计积分
- `sessionLevelCount` - 本局过关数
- `sessionWordsCount` - 本局完成单词数

### 8.4 再玩一次功能

- 需要扣除10点体力
- 重置所有累计状态
- 重新加载关卡并启动计时器

---

## 技术实现文件

### 后端
- `src/backend/main.py` - API实现
  - 奖励生成：`/api/game/generate-reward`
  - 奖励领取：`/api/game/claim-reward`
  - 体力管理：`/api/user/energy`
  - 道具管理：`/api/user/props`

### 前端
- `src/frontend/src/views/Game.vue` - 游戏主界面
  - `fetchRewardsFromBackend()` - 从后端获取奖励
  - `claimRewards()` - 领取奖励
  - `levelStars` - 星级计算
- `src/frontend/src/stores/game.js` - 游戏状态管理
  - 计时器逻辑
  - 关卡进度管理
