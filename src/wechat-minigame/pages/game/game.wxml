<!--pages/game/game.wxml-->
<view class="game-screen">
  <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
  <view class="top-bar">
    <view class="game-card-compact">
      <!-- ç¬¬ä¸€è¡Œï¼šç”¨æˆ·ä¿¡æ¯ + è¿”å› -->
      <view class="top-row-1">
        <view class="back-btn-icon" bindtap="goBack">â†</view>
        <view class="user-info-mini">
          <text class="mini-avatar">{{ userAvatar }}</text>
          <text class="mini-name">{{ userName }}</text>
        </view>
        <view class="mini-stats">
          <text class="mini-stat">âš¡{{ energy }}</text>
          <text class="mini-stat">ğŸ’¡{{ hintCount }}</text>
          <text class="mini-stat">ğŸ”Š{{ speakCount }}</text>
        </view>
      </view>
      
      <!-- ç¬¬äºŒè¡Œï¼šæ¸¸æˆçŠ¶æ€ -->
      <view class="top-row-2">
        <view class="game-mode-badge">
          <text>{{ modeIcon }} {{ modeName }}</text>
          <text wx:if="{{ mode === 'campaign' }}" class="level-badge">L{{ currentLevel }}</text>
        </view>
        <view class="timer-mini {{ isTimeWarning ? 'warning' : '' }}">
          <text>â±ï¸{{ formattedTimer }}</text>
        </view>
        <view class="score-mini">
          <text>ğŸŒŸ{{ score }}</text>
        </view>
        <view class="progress-mini">
          <text wx:if="{{ showSessionScore }}" class="session-score-mini">+{{ sessionScore }}</text>
          <view class="progress-bar-mini">
            <view class="progress-fill-mini" style="width: {{ progress }}%;"></view>
          </view>
          <text class="progress-text-mini">{{ completedWordsCount }}/{{ wordsCount }}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view class="main-content">
    <!-- æ¸¸æˆç½‘æ ¼åŒº -->
    <view class="game-card-main">
      <view class="grid-container" style="max-width: {{ gridSize * 80 }}rpx;">
        <view class="grid" style="grid-template-columns: repeat({{ gridSize }}, 1fr);">
          <view 
            wx:for="{{ cells }}" 
            wx:for-item="row" 
            wx:for-index="rowIndex"
            wx:key="rowIndex"
            class="grid-row"
          >
            <view
              wx:for="{{ row }}"
              wx:for-item="cell"
              wx:for-index="colIndex"
              wx:key="colIndex"
              class="letter-cell {{ getCellClass(rowIndex, colIndex, cell) }}"
              bindtap="handleCellClick"
              data-row="{{ rowIndex }}"
              data-col="{{ colIndex }}"
            >
              <!-- çº¿ç´¢ç¼–å· -->
              <text wx:if="{{ getClueNumber(rowIndex, colIndex) }}" class="clue-number">
                {{ getClueNumber(rowIndex, colIndex) }}
              </text>
              <text wx:if="{{ cell !== null }}" class="cell-letter">
                {{ getAnswer(rowIndex, colIndex) }}
              </text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å•è¯åˆ—è¡¨ -->
    <scroll-view class="words-section" scroll-y>
      <view class="words-list">
        <view 
          wx:for="{{ sortedWords }}" 
          wx:key="id"
          class="word-item {{ isWordCompleted(item.id) ? 'completed' : '' }} {{ selectedWord && selectedWord.id === item.id ? 'selected' : '' }}"
          bindtap="selectWord"
          data-word="{{ item }}"
        >
          <text class="word-index">{{ item.clue_number || (index + 1) }}</text>
          <text class="word-direction-badge">{{ item.direction === 'across' ? 'æ¨ª' : 'ç«–' }}</text>
          
          <!-- å·²å®Œæˆ -->
          <block wx:if="{{ isWordCompleted(item.id) }}">
            <text class="word-text" bindtap="openWordDetail" data-word="{{ item }}">{{ item.word }}</text>
            <text class="word-definition">{{ item.definition }}</text>
            <view class="speak-btn" catchtap="speakWord" data-word="{{ item.word }}">ğŸ”Š</view>
          </block>
          
          <!-- æœªå®Œæˆ -->
          <block wx:else>
            <view class="word-placeholder">
              <text 
                wx:for="{{ getWordHint(item) }}" 
                wx:for-item="char"
                wx:key="*this"
                class="placeholder-char {{ char !== '_' ? 'hint-letter' : '' }}"
              >{{ char }}</text>
            </view>
            <text class="word-translation-hint">{{ item.definition }}</text>
          </block>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨é”®ç›˜åŒº -->
  <view class="keyboard-section">
    <view class="keyboard-container">
      <!-- ç¬¬ä¸€è¡Œï¼šQWERTYUIOP -->
      <view class="keyboard-row">
        <view 
          wx:for="{{ 'QWERTYUIOP'.split('') }}" 
          wx:key="*this"
          class="keyboard-key {{ isLetterNeeded(item) ? 'key-highlight' : '' }}"
          bindtap="inputLetter"
          data-letter="{{ item }}"
        >{{ item }}</view>
      </view>
      <!-- ç¬¬äºŒè¡Œï¼šASDFGHJKL + åˆ é™¤ -->
      <view class="keyboard-row">
        <view 
          wx:for="{{ 'ASDFGHJKL'.split('') }}" 
          wx:key="*this"
          class="keyboard-key {{ isLetterNeeded(item) ? 'key-highlight' : '' }}"
          bindtap="inputLetter"
          data-letter="{{ item }}"
        >{{ item }}</view>
        <view class="keyboard-key delete-key" bindtap="deleteLetter">âŒ«</view>
      </view>
      <!-- ç¬¬ä¸‰è¡Œï¼šZXCVBNM + é“å…· -->
      <view class="keyboard-row">
        <view 
          wx:for="{{ 'ZXCVBNM'.split('') }}" 
          wx:key="*this"
          class="keyboard-key {{ isLetterNeeded(item) ? 'key-highlight' : '' }}"
          bindtap="inputLetter"
          data-letter="{{ item }}"
        >{{ item }}</view>
        <view 
          class="keyboard-prop-btn {{ hintActive ? 'active' : '' }}"
          bindtap="useHintProp"
        >
          <text class="prop-emoji">ğŸ’¡</text>
          <text class="prop-num">{{ hintCount }}</text>
        </view>
        <view 
          class="keyboard-prop-btn {{ speakActive ? 'active' : '' }}"
          bindtap="useSpeakProp"
        >
          <text class="prop-emoji">ğŸ”Š</text>
          <text class="prop-num">{{ speakCount }}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{ loading }}" class="overlay">
    <view class="loading-card">
      <text class="loading-icon">â³</text>
      <text class="loading-text">æ­£åœ¨åŠ è½½å…³å¡...</text>
    </view>
  </view>

  <!-- é€šå…³å¼¹çª— -->
  <view wx:if="{{ showCompleteModal }}" class="overlay">
    <view class="complete-modal">
      <!-- è®¡æ—¶/PK/æ— é™æ¨¡å¼ç»“æŸ -->
      <block wx:if="{{ timedModeEnded }}">
        <view class="trophy-area">
          <text class="trophy-emoji">{{ mode === 'endless' ? 'â™¾ï¸' : 'â°' }}</text>
          <view class="timed-result">
            <text class="timed-count">{{ sessionLevelCount }}</text>
            <text class="timed-label">å…³</text>
            <text class="timed-count" style="margin-left: 24rpx;">{{ sessionWordsCount }}</text>
            <text class="timed-label">è¯</text>
          </view>
        </view>
        
        <text class="complete-title">â±ï¸ æ—¶é—´åˆ°ï¼</text>
        <text class="stats-inline">ğŸŒŸ{{ sessionScore }}åˆ† Â· ğŸ“{{ sessionWordsCount }}è¯ Â· ğŸ¯{{ sessionLevelCount }}å…³</text>
      </block>
      
      <!-- æ­£å¸¸é€šå…³ -->
      <block wx:else>
        <view class="trophy-area">
          <text class="trophy-emoji">{{ isLastLevel ? 'ğŸ†' : 'ğŸ‰' }}</text>
          <view class="stars-row">
            <text class="star {{ currentStars >= 1 ? 'earned' : '' }}">{{ currentStars >= 1 ? 'â­' : 'â˜†' }}</text>
            <text class="star big {{ currentStars >= 2 ? 'earned' : '' }}">{{ currentStars >= 2 ? 'â­' : 'â˜†' }}</text>
            <text class="star {{ currentStars >= 3 ? 'earned' : '' }}">{{ currentStars >= 3 ? 'â­' : 'â˜†' }}</text>
          </view>
          <text class="stars-hint">{{ currentStars === 3 ? 'å®Œç¾ï¼' : currentStars === 2 ? 'å¾ˆæ£’ï¼' : 'ç»§ç»­åŠ æ²¹ï¼' }}</text>
        </view>
        
        <text class="complete-title">{{ isLastLevel ? 'æ­å–œå…¨éƒ¨é€šå…³ï¼' : 'ç¬¬' + currentLevel + 'å…³ é€šå…³ï¼' }}</text>
        <text class="stats-inline">â±ï¸{{ formattedTimer }} Â· ğŸŒŸ{{ score }}åˆ† Â· ğŸ“{{ completedWordsCount }}è¯</text>
      </block>
      
      <!-- å¥–åŠ±å±•ç¤º -->
      <view wx:if="{{ earnedRewards.length > 0 }}" class="reward-display">
        <text class="reward-title">ğŸ è·å¾—å¥–åŠ±</text>
        <view class="reward-items">
          <view wx:for="{{ earnedRewards }}" wx:key="type" class="reward-item">
            <text class="reward-icon">{{ item.icon }}</text>
            <text class="reward-value">+{{ item.value }}</text>
            <text class="reward-name">{{ item.name }}</text>
          </view>
        </view>
      </view>
      
      <!-- æŒ‰é’® -->
      <view class="modal-btns">
        <view class="modal-btn secondary" bindtap="goBack">è¿”å›</view>
        <view 
          wx:if="{{ earnedRewards.length > 0 }}"
          class="modal-btn reward {{ rewardClaimed ? 'claimed' : '' }}" 
          bindtap="claimRewards"
        >{{ rewardClaimed ? 'å·²é¢†å–' : 'é¢†å¥–' }}</view>
        <view wx:if="{{ !isLastLevel }}" class="modal-btn primary" bindtap="goNextLevel">
          {{ timedModeEnded ? 'å†ç©ä¸€æ¬¡' : 'ä¸‹ä¸€å…³' }}
        </view>
        <view wx:else class="modal-btn success" bindtap="replayLevel">å†ç©ä¸€æ¬¡</view>
      </view>
    </view>
  </view>

  <!-- ä½“åŠ›ä¸è¶³å¼¹çª— -->
  <view wx:if="{{ showEnergyModal }}" class="overlay">
    <view class="energy-modal">
      <text class="energy-modal-icon">ğŸ˜´</text>
      <text class="energy-modal-title">ä½“åŠ›ä¸è¶³</text>
      <text class="energy-modal-text">å½“å‰ä½“åŠ›ä¸è¶³ä»¥å¼€å§‹æ¸¸æˆ</text>
      <view class="energy-modal-info">
        <text class="energy-current">å½“å‰ä½“åŠ›: âš¡{{ energy }}</text>
        <text class="energy-need">éœ€è¦: âš¡{{ energyRequired }}</text>
      </view>
      <view class="energy-modal-buttons">
        <view class="energy-modal-btn claim" bindtap="claimFreeEnergy">ğŸ é¢†å–ä½“åŠ› +30</view>
        <view class="energy-modal-btn rest" bindtap="closeEnergyModalAndGoBack">ä¼‘æ¯ä¸€ä¸‹</view>
      </view>
    </view>
  </view>
</view>
