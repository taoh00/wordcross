# 我爱填单词 WordCross - 游戏架构设计文档

**版本:** 1.0
**作者:** Cloud Dragonborn (Game Architect)
**日期:** 2026-01-24
**项目类型:** Educational Puzzle / Crossword Game

---

## 1. 架构概述

### 1.1 设计哲学

> "Architecture is about delaying decisions until you have enough data, 
> while building foundations strong enough for tomorrow's load."
> — Cloud Dragonborn

本架构采用 **可伸缩单体优先** (Scalable Monolith First) 策略:
- 初期快速开发验证产品
- 预留微服务拆分接口
- 性能敏感路径优化

### 1.2 系统全景图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        客户端层 (Client Layer)                       │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  Web App    │  │  微信小程序  │  │  iOS App   │  │ Android App │ │
│  │  (Vue 3)    │  │  (UniApp)   │  │  (后续)     │  │   (后续)    │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘ │
│         │                │                │                │        │
│         └────────────────┴────────────────┴────────────────┘        │
│                                   │                                  │
│                              HTTPS/WSS                               │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────────┐
│                        API网关层 (API Gateway)                       │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  Nginx / Traefik                                                ││
│  │  - 负载均衡   - SSL终结   - 限流   - 静态资源缓存              ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────────┐
│                      应用服务层 (Application Layer)                  │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    FastAPI Application                        │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │  │
│  │  │ Puzzle API  │  │  Game API   │  │  User API   │           │  │
│  │  │  /puzzle/*  │  │  /game/*    │  │  /user/*    │           │  │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘           │  │
│  │         │                │                │                   │  │
│  │  ┌──────▼────────────────▼────────────────▼──────┐           │  │
│  │  │              Service Layer                     │           │  │
│  │  │  ┌──────────────┐  ┌──────────────┐           │           │  │
│  │  │  │PuzzleService │  │ GameService  │           │           │  │
│  │  │  └──────────────┘  └──────────────┘           │           │  │
│  │  │  ┌──────────────┐  ┌──────────────┐           │           │  │
│  │  │  │VocabService  │  │ UserService  │           │           │  │
│  │  │  └──────────────┘  └──────────────┘           │           │  │
│  │  └───────────────────────────────────────────────┘           │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                   WebSocket Handler (PK模式)                   │  │
│  │  - 房间管理   - 实时同步   - 状态广播                         │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────────┐
│                        核心引擎层 (Core Engine)                      │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                  Puzzle Generation Engine                       ││
│  │  ┌──────────────────┐  ┌──────────────────────────────────────┐││
│  │  │ CrosswordGenerator│  │       CSP Puzzle Generator         │││
│  │  │  (稀疏布局)       │  │  (密集布局 - 纽约时报风格)          │││
│  │  │  - 交叉放置算法   │  │  - AC-3弧一致性                     │││
│  │  │  - 预填字母策略   │  │  - MRV启发式                        │││
│  │  │  - 多轮重试机制   │  │  - 回溯搜索                         │││
│  │  └──────────────────┘  └──────────────────────────────────────┘││
│  │                                                                 ││
│  │  ┌──────────────────┐  ┌──────────────────────────────────────┐││
│  │  │ VocabularyManager│  │         Word Index                   │││
│  │  │  - 词库加载      │  │  - 按长度索引                        │││
│  │  │  - 难度分级      │  │  - 按位置-字母索引                   │││
│  │  │  - 词汇筛选      │  │  - 高效约束查询                      │││
│  │  └──────────────────┘  └──────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────────┐
│                         数据层 (Data Layer)                          │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │   Redis     │  │  SQLite/    │  │  词库JSON   │  │ 关卡缓存    │ │
│  │  (缓存/     │  │ PostgreSQL  │  │  (静态数据) │  │ (LRU Cache) │ │
│  │  会话/排行) │  │  (用户数据) │  │             │  │             │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心模块架构

### 2.1 填字游戏生成引擎

这是系统的核心，负责生成高质量的填字谜题。

#### 2.1.1 双引擎策略

```
┌────────────────────────────────────────────────────────────────┐
│                    Puzzle Generator Factory                     │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   请求 → [难度判断] →┬→ 稀疏布局 → CrosswordGenerator          │
│                      │   (1-30关)    - 传统交叉填字             │
│                      │               - 有空白格                 │
│                      │               - 适合初学者               │
│                      │                                          │
│                      └→ 密集布局 → CSPPuzzleGenerator           │
│                         (31+关)     - NYT Mini风格              │
│                                     - 无空白格                  │
│                                     - 高难度挑战                │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

#### 2.1.2 算法复杂度分析

| 算法组件 | 时间复杂度 | 空间复杂度 | 说明 |
|---------|-----------|-----------|------|
| 单词放置检查 | O(n) | O(1) | n=单词长度 |
| 交叉点搜索 | O(m×k²) | O(k) | m=已放置词数, k=平均词长 |
| CSP回溯搜索 | O(d^n) | O(n×d) | n=槽位数, d=域大小 |
| AC-3约束传播 | O(n²d³) | O(n²) | 可大幅剪枝 |
| 单词索引查询 | O(1) | O(w×l) | w=词汇量, l=最大词长 |

#### 2.1.3 生成流程

```
                    ┌─────────────────┐
                    │   Generate      │
                    │   Request       │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ 加载词库        │
                    │ VocabularyManager│
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
     ┌────────▼────────┐    │     ┌────────▼────────┐
     │ 按长度索引单词   │    │     │ 预过滤可行词    │
     │ WordIndex       │    │     │ (CSP模式)       │
     └────────┬────────┘    │     └────────┬────────┘
              │              │              │
              └──────────────┼──────────────┘
                             │
                    ┌────────▼────────┐
                    │ 选择生成策略    │
                    │                 │
                    │ level≤30: 稀疏  │
                    │ level>30: 密集  │
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
 ┌────────▼────────┐        │         ┌────────▼────────┐
 │ 稀疏布局生成     │        │         │ CSP模板求解     │
 │                 │        │         │                 │
 │ 1. 放置首词居中  │        │         │ 1. 选择模板     │
 │ 2. 寻找交叉点   │        │         │ 2. 初始化槽位   │
 │ 3. 评分放置     │        │         │ 3. MRV变量选择  │
 │ 4. 添加预填字母  │        │         │ 4. 前向检查     │
 │                 │        │         │ 5. 回溯搜索     │
 └────────┬────────┘        │         └────────┬────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
                    ┌────────▼────────┐
                    │ 构建Puzzle对象  │
                    │ - grid[][]      │
                    │ - words[]       │
                    │ - clue_numbers  │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ 添加预填字母    │
                    │ (根据难度)      │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ 缓存答案        │
                    │ _answer_cache   │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ 返回API响应     │
                    └─────────────────┘
```

---

### 2.2 词汇管理系统

#### 2.2.1 词库层级结构

```
┌─────────────────────────────────────────────────────────────────┐
│                     Vocabulary Hierarchy                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Level 1: 基础教育词汇                                          │
│  ├── primary    小学词汇    (~800词)    ████░░░░░░              │
│  ├── ket        KET考试     (~1000词)   █████░░░░░              │
│  └── pet        PET考试     (~1500词)   ███████░░░              │
│                                                                  │
│  Level 2: 中学词汇                                              │
│  ├── junior     初中词汇    (~1600词)   ████████░░              │
│  └── senior     高中词汇    (~3500词)   █████████████████       │
│                                                                  │
│  Level 3: 高等教育词汇                                          │
│  ├── cet4       大学四级    (~4500词)   ██████████████████████  │
│  ├── cet6       大学六级    (~6000词)   ████████████████████████│
│  └── postgrad   考研词汇    (~5500词)   ███████████████████████ │
│                                                                  │
│  Level 4: 留学考试词汇                                          │
│  ├── ielts      雅思        (~7000词)   ██████████████████████████
│  ├── toefl      托福        (~8000词)   ████████████████████████████
│  └── gre        GRE         (~10000词)  ██████████████████████████████
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 词汇数据结构

```python
@dataclass
class VocabularyWord:
    id: int                    # 唯一标识
    word: str                  # 英文单词
    definition: str            # 中文释义
    phonetic: Optional[str]    # 音标
    difficulty: int            # 难度等级 1-5
    frequency: int             # 词频等级
    tags: List[str]            # 标签 (noun, verb, etc.)
    
# 内存索引结构
class WordIndex:
    by_length: Dict[int, List[str]]           # 按长度索引
    by_first_letter: Dict[str, List[str]]     # 按首字母索引
    position_letter: Dict[(pos, char), Set]   # 按位置-字母索引
```

---

### 2.3 游戏状态管理

#### 2.3.1 客户端状态 (Pinia Store)

```javascript
// stores/game.js
export const useGameStore = defineStore('game', {
  state: () => ({
    // 游戏配置
    currentGroup: 'cet4',         // 当前词库
    currentMode: 'campaign',       // 游戏模式
    
    // 当前关卡
    level: 1,
    puzzle: null,                  // 谜题数据
    grid: [],                      // 用户填写的网格
    
    // 游戏进度
    completedWords: [],            // 已完成的单词
    correctLetters: {},            // 正确的字母位置
    currentWord: null,             // 当前选中的单词
    
    // 计时
    startTime: null,
    elapsedTime: 0,
    
    // 统计
    hintsUsed: 0,
    mistakes: 0,
    score: 0
  }),
  
  getters: {
    isComplete: (state) => ...,
    starRating: (state) => ...,
    accuracy: (state) => ...
  },
  
  actions: {
    async loadPuzzle(level, group) { ... },
    fillLetter(row, col, letter) { ... },
    verifyWord(wordId) { ... },
    useHint() { ... },
    completeLevel() { ... }
  }
})
```

#### 2.3.2 服务端会话管理

```
┌─────────────────────────────────────────────────────────────────┐
│                      Session Management                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  匿名用户流程:                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ 首次访问    │ →  │ 生成UUID   │ →  │ LocalStorage │         │
│  │             │    │ 临时身份   │    │ 保存进度    │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                  │
│  登录用户流程:                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ 登录/注册   │ →  │ JWT Token  │ →  │ Redis缓存   │         │
│  │             │    │ 颁发       │    │ + DB持久化  │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                  │
│  进度同步:                                                      │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ 用户登录    │ →  │ 合并本地   │ →  │ 同步到云端  │         │
│  │             │    │ 与云端进度 │    │             │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

### 2.4 实时对战架构 (PK模式)

```
┌─────────────────────────────────────────────────────────────────┐
│                    PK Mode Architecture                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────┐              ┌─────────────┐                   │
│  │  Player A   │              │  Player B   │                   │
│  │  (Browser)  │              │  (Browser)  │                   │
│  └──────┬──────┘              └──────┬──────┘                   │
│         │ WebSocket                  │ WebSocket                │
│         │                            │                          │
│         └────────────┬───────────────┘                          │
│                      │                                          │
│              ┌───────▼───────┐                                  │
│              │ WS Handler    │                                  │
│              │ (FastAPI)     │                                  │
│              └───────┬───────┘                                  │
│                      │                                          │
│              ┌───────▼───────┐                                  │
│              │ Room Manager  │                                  │
│              │               │                                  │
│              │ - 匹配队列    │                                  │
│              │ - 房间状态    │                                  │
│              │ - 同步广播    │                                  │
│              └───────┬───────┘                                  │
│                      │                                          │
│         ┌────────────┼────────────┐                             │
│         │            │            │                             │
│  ┌──────▼──────┐ ┌───▼───┐ ┌─────▼─────┐                       │
│  │ MatchQueue  │ │ Room  │ │ GameSync  │                       │
│  │ (Redis)     │ │ State │ │ (Pub/Sub) │                       │
│  └─────────────┘ └───────┘ └───────────┘                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

消息协议:
┌────────────────────────────────────────┐
│ {                                      │
│   "type": "action_type",               │
│   "room_id": "uuid",                   │
│   "player_id": "uuid",                 │
│   "payload": { ... },                  │
│   "timestamp": 1706000000000           │
│ }                                      │
└────────────────────────────────────────┘

消息类型:
- match_request: 请求匹配
- match_found: 匹配成功
- game_start: 游戏开始 (包含puzzle)
- word_complete: 完成单词
- progress_update: 进度同步
- game_end: 游戏结束
```

---

## 3. API设计

### 3.1 RESTful API

```yaml
# Puzzle API
GET  /api/puzzle/campaign/{level}?group={group}
     → 获取闯关模式关卡
     
GET  /api/puzzle/random?group={group}&difficulty={easy|medium|hard}
     → 获取随机关卡
     
POST /api/puzzle/verify
     → 验证答案
     Body: { "word_id": int, "answer": string }
     
# User API (V2)
POST /api/user/register
POST /api/user/login
GET  /api/user/profile
PUT  /api/user/progress

# Leaderboard API
GET  /api/leaderboard/{mode}?group={group}&limit={n}
POST /api/leaderboard/submit
```

### 3.2 WebSocket API

```yaml
# PK Mode
WS /ws/pk

# 客户端 → 服务端
{ "type": "match_request", "group": "cet4" }
{ "type": "word_complete", "word_id": 123, "time_ms": 5000 }
{ "type": "leave_room" }

# 服务端 → 客户端
{ "type": "match_found", "room_id": "...", "opponent": {...} }
{ "type": "game_start", "puzzle": {...} }
{ "type": "opponent_progress", "completed": [...] }
{ "type": "game_end", "winner": "player_a", "scores": {...} }
```

---

## 4. 性能预算

### 4.1 响应时间目标

| 操作 | 目标 | P95 | P99 |
|-----|------|-----|-----|
| 首屏加载 | < 2s | < 3s | < 5s |
| 关卡生成 | < 500ms | < 1s | < 2s |
| 答案验证 | < 50ms | < 100ms | < 200ms |
| WS消息延迟 | < 50ms | < 100ms | < 200ms |

### 4.2 资源预算

| 资源 | 预算 | 说明 |
|-----|------|------|
| 前端JS Bundle | < 200KB gzip | 代码分割 |
| 词库JSON | < 500KB/组 | 按需加载 |
| 内存使用 | < 100MB | 服务端 |
| 并发用户 | 1000+ | 单实例 |

---

## 5. 数据模型

### 5.1 核心实体

```sql
-- 用户表
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) UNIQUE,
    username VARCHAR(50) UNIQUE,
    email VARCHAR(100),
    password_hash VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 游戏进度表
CREATE TABLE game_progress (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    vocab_group VARCHAR(20),
    level_reached INTEGER DEFAULT 1,
    total_words_learned INTEGER DEFAULT 0,
    total_time_played INTEGER DEFAULT 0,
    updated_at TIMESTAMP
);

-- 关卡完成记录
CREATE TABLE level_completions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    vocab_group VARCHAR(20),
    level INTEGER,
    stars INTEGER, -- 1-3星
    time_spent INTEGER, -- 秒
    hints_used INTEGER,
    completed_at TIMESTAMP
);

-- 排行榜 (Redis + 定期持久化)
-- ZADD leaderboard:campaign:cet4 <score> <user_id>
-- ZADD leaderboard:endless:cet4 <word_count> <user_id>
```

---

## 6. 部署架构

### 6.1 开发环境

```
┌─────────────────────────────────────────┐
│  Docker Compose                         │
├─────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌────────┐│
│  │ Frontend │  │ Backend  │  │ Redis  ││
│  │ Vite Dev │  │ Uvicorn  │  │        ││
│  │ :5173    │  │ :8000    │  │ :6379  ││
│  └──────────┘  └──────────┘  └────────┘│
└─────────────────────────────────────────┘
```

### 6.2 生产环境

```
┌─────────────────────────────────────────────────────────────────┐
│                         Cloud Provider                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────┐                                                │
│  │   CDN       │ ← 静态资源 (JS/CSS/Images)                     │
│  └──────┬──────┘                                                │
│         │                                                        │
│  ┌──────▼──────┐                                                │
│  │   Nginx     │ ← SSL终结, 反向代理                            │
│  │   Gateway   │                                                │
│  └──────┬──────┘                                                │
│         │                                                        │
│  ┌──────▼──────────────────────────────────┐                    │
│  │  Container Orchestration (K8s/Compose)  │                    │
│  │  ┌──────────┐  ┌──────────┐            │                    │
│  │  │ API Pod  │  │ API Pod  │  ← 水平扩展 │                    │
│  │  └──────────┘  └──────────┘            │                    │
│  └──────────────────┬──────────────────────┘                    │
│                     │                                            │
│  ┌──────────────────┼──────────────────────┐                    │
│  │                  │                      │                    │
│  │  ┌───────────────▼───────────────┐     │                    │
│  │  │         Redis Cluster         │     │                    │
│  │  │   (Session/Cache/Leaderboard) │     │                    │
│  │  └───────────────────────────────┘     │                    │
│  │                                         │                    │
│  │  ┌───────────────────────────────┐     │                    │
│  │  │        PostgreSQL             │     │                    │
│  │  │   (用户数据/持久化)            │     │                    │
│  │  └───────────────────────────────┘     │                    │
│  │                                         │                    │
│  └─────────────────────────────────────────┘                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 安全考虑

### 7.1 安全层级

| 层级 | 措施 |
|------|------|
| 传输层 | HTTPS/WSS, TLS 1.3 |
| API层 | 速率限制, JWT验证, CORS |
| 应用层 | 输入验证, SQL参数化 |
| 数据层 | 密码bcrypt哈希, 敏感数据加密 |

### 7.2 防作弊机制

```
1. 答案不下发 - 仅返回验证结果
2. 服务端计时 - 不信任客户端时间
3. 请求签名 - 防止重放攻击
4. 异常检测 - 标记可疑行为
```

---

## 8. 关键决策记录

### ADR-001: 选择双引擎策略
**决策**: 使用稀疏布局(传统交叉)和密集布局(CSP)两套算法
**原因**: 
- 稀疏布局适合初学者，生成快速
- 密集布局提供NYT Mini风格的高级体验
- 两者互补，覆盖不同难度需求

### ADR-002: 先单体后拆分
**决策**: 初期采用单体架构，预留微服务拆分接口
**原因**:
- 快速验证产品可行性
- 避免过早优化
- 预留PK模块独立拆分的可能

### ADR-003: 匿名优先设计
**决策**: 支持无需注册即可游玩，进度存本地
**原因**:
- 降低用户门槛
- 符合小游戏特性
- 登录后可同步本地进度

---

## 附录A: 文件结构

```
src/
├── backend/
│   ├── main.py                    # FastAPI 入口
│   ├── puzzle_generator.py        # 稀疏填字生成器
│   ├── csp_puzzle_generator.py    # CSP密集填字生成器
│   ├── vocabulary.py              # 词汇管理器
│   ├── test_level_generation.py   # 算法测试
│   └── routers/                   # API路由 (待创建)
│       ├── puzzle.py
│       ├── game.py
│       └── user.py
│
├── frontend/
│   ├── src/
│   │   ├── App.vue
│   │   ├── main.js
│   │   ├── router.js
│   │   ├── stores/
│   │   │   └── game.js            # Pinia状态管理
│   │   └── views/
│   │       ├── Home.vue           # 首页/模式选择
│   │       ├── Game.vue           # 游戏主界面
│   │       └── Leaderboard.vue    # 排行榜
│   └── ...
│
└── data/
    └── vocabulary/                 # 词库JSON文件
        ├── primary.json
        ├── cet4.json
        ├── cet6.json
        └── ...
```

---

**文档版本历史**:
- v1.0 (2026-01-24): 初始架构设计 - Cloud Dragonborn
